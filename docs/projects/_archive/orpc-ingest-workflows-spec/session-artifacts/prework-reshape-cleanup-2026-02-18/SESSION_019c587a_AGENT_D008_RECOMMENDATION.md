# D-008 Recommendation

## Baseline Lock
1. Host entrypoints MUST import and invoke `extendedTracesMiddleware()` before any other modules so the tracer provider and instrumentation patches are in place before the `Inngest` client, routing helpers, or `registerOrpcRoutes` execute. This mirrors the official guidance that `extendedTracesMiddleware()` runs first so every function and library is auto-instrumented.
2. The host bootstrap (`apps/server/src/rawr.ts` plus the generated `rawr.hq.ts` data) must create one `CoordinationRuntimeAdapter`, build a single Inngest client bundled with the extended traces middleware, generate the workflow functions, and mount `/api/inngest`, `/api/workflows/*`, and the `/rpc`/OpenAPI families in that order so trace context spans the entire lifecycle. No parallel Inngest bundles or duplicate mounts are allowed.
3. Boundary vs runtime middleware control planes remain distinct: oRPC/Elysia middleware (auth/validation/rate limits) lives on `/rpc`/OpenAPI handlers, while Inngest middleware (`extendedTraces`, durable controls) stays in the Inngest client/function stack. Plugin authors may add per-function middleware on top of the host-provided instrumentation, but they inherit the host's `extendedTraces` anchor and may not reorder or replace it.

## D-009 / D-010 Dispositions
- **D-009 (Deduped middleware for heavy work):** Keep the current packet guidance as a `SHOULD`: heavy middleware that costs I/O or repeated validations should guard with context-cached markers (per `AXIS_06` and the oRPC best-practices document) rather than relying on the built-in dedupe rule, which only covers leading-subset/same-order middleware chains. No new lock yet; continue to document the recommendation until repeated implementation evidence demands codification.
- **D-010 (Finished-hook guardrail):** Continue treating `finished` as a lifecycle hook that may not run exactly once—the Inngest lifecycle doc explicitly notes it can be skipped or invoked multiple times during retries—so keep its usage limited to idempotent or non-critical side effects. No change to the locked policy; capture this as operational guidance in the packet while the decision remains open.
