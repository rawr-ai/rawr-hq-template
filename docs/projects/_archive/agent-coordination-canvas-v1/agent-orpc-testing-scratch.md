# Agent Scratch: oRPC Testing Harnesses

## Mission
Define the testing scope required to prove a repo-wide oRPC migration for Lane B (testing harnesses). Connect every layer from the coordination domain through the Rawr server entrypoints so we can: (a) walk backwards from existing HTTP/manual tests, (b) plan new ORPC-first assertions, and (c) surface the gaps we must fill before trusting the cutover.

## Current test harness audit
- `apps/server/test/health.test.ts` drives `createServerApp()` and `mountServerPlugins()` in-process via `app.handle(new Request(...))`. It is the only guardrail ensuring `/health` stays wired before we introduce ORPC routes. The same `app.ts`/`plugins.ts` pair constructs the base `Elysia` instance that ultimately hosts the coordination router in `apps/server/src/rawr.ts` and `apps/server/src/coordination.ts`.
- `apps/server/test/rawr.test.ts` is the bulk of API integration coverage: it checks plugin module serving, `/api/inngest`, and every `/rawr/coordination` workflow lifecycle step by issuing `Request` objects with `fetch` semantics. Those routes compose `packages/coordination` (validation/storage/envelopes), `packages/coordination-inngest` (queue/processing), and `packages/coordination-observability` (trace links) under `registerCoordinationRoutes`.
- Domain packages already have in-function harnesses that require no HTTP: `packages/coordination/test/coordination.test.ts` exercises validation, storage, envelopes, and timeline persistence functions; `packages/coordination-inngest/test/inngest-adapter.test.ts` exercises `queueCoordinationRunWithInngest`/`processCoordinationRunEvent` with mocks, `packages/coordination-observability/test/observability.test.ts` covers event building, and `packages/control-plane/test/control-plane.test.ts` guards config normalization. These suites can host the early ORPC procedure and contract assertions without touching `Request`.
- CLI-focused suites such as `apps/cli/test/workflow-harden.test.ts` and `apps/cli/test/workflow-harden.e2e.test.ts` spawn `bun src/index.ts …` and treat the command surface as a black box; they currently do not validate API contracts at all, so we will keep them as high-level regression guards.

## Tests requiring HTTP/manual transport
1. `apps/server/test/health.test.ts` – uses `app.handle(new Request("http://localhost/health"))` to prove the health route/responder lives on the same `Elysia` instance we will eventually wire to ORPC. Any new handler must keep returning the same responses to avoid regression.
2. `apps/server/test/rawr.test.ts` – issues a sequence of HTTP requests (`/rawr/plugins/web/:dirName`, `/api/inngest`, `/rawr/coordination/*`) to validate output envelopes, Inngest wiring, and timeline status. The test also mocks the Inngest client passed to `registerCoordinationRoutes`. All of these rely on manual `Request` creation plus JSON parsing, so they are the candidates we want to replace with more focused ORPC handler tests.

## ORPC Target Testing Matrix
| Layer | Current coverage | ORPC target strategy |
| --- | --- | --- |
| Procedure/unit | `packages/coordination/test/coordination.test.ts` already exercises individual validation/storage/envelope helpers by calling them directly. | Introduce a `packages/coordination/src/contract.ts` (or equivalent) that exports the contract & procedure definitions. Add Vitest suites that import the contract, call `implement(contract)` handlers, and assert pure inputs/outputs without instantiating `Elysia` or creating `Request` objects. Mirror the existing workflow payloads used in `coordination.test.ts` so we keep coverage on schema validation and timeline error paths through ORPC vacuum tests. |
| Handler integration | `apps/server/test/rawr.test.ts` currently exercises `registerCoordinationRoutes` via `app.handle`. | Replace most of this suite with tests that instantiate the ORPC `RPCHandler`/`OpenAPIHandler` directly (without HTTP) and feed them RPC payloads (`{ procedure: "coordination.createWorkflow", input: {...} }`). Keep a small subset of calls that exercise `registerCoordinationRoutes` wiring to ensure the router is mounted correctly—the existing `app.handle` usage can be trimmed down to a couple of transport-level smoke tests. |
| Transport/E2E | The remaining `app.handle` calls plus the CLI `workflow-harden` e2e test are the only suites that exercise the Fetch transport or actual command surface. | Retain one `apps/server/test/rawr-lite.test.ts` that fires actual `Request` objects at `/rawr/coordination/workflows`/`runs`. Keep the CLI e2e as-is to guard end-to-end behavior. These will now validate that the ORPC handler is switching to HTTP/fetch correctly rather than verifying every procedure. |
| Contract drift | None. | Add a snapshot test that outputs the serialized contract/`oc.router` definition via `miniContract` and compares it against a checked-in fixture (e.g., `packages/coordination/test/fixtures/contract.snapshot.json`). Trigger this test after any procedure change to catch accidental drift before the server or Inngest layers consume it. |

## Files/suites to change + migration sequencing
1. **Contract + procedure definition (packages/coordination)** – introduce or expand `packages/coordination/src/contract.ts`/`index.ts` so that validation, storage, and runtime helpers are reused by ORPC handlers. Make sure the contract exports the procedure names used by `apps/server` and `packages/coordination-inngest`. Update `packages/coordination/test/coordination.test.ts` to import the contract and cover the same logic via handler invocations instead of direct helper calls where possible.
2. **Server routing (apps/server/src/coordination.ts & apps/server/src/rawr.ts)** – wire `implement(contract)` and instantiate `RPCHandler`/`OpenAPIHandler` as documented in `docs/projects/agent-coordination-canvas-v1/agent-orpc-network-server-scratch.md`. Tests in `apps/server/test/rawr.test.ts` will shift to hitting the handler’s `handle()` method, and the helper that mounts `/api/inngest` must still use the Inngest function from `packages/coordination-inngest/src/index.ts`.
3. **Handler integration tests (apps/server/test/rawr.test.ts plus a new `apps/server/test/coordination.rpc.test.ts`)** – restructure the suite so that the bulk of assertions are now ORPC-centric, leaving only 1–2 HTTP smoke tests. Add a new test file that imports the exported RPC procedures and asserts success/failure/validation flows without `Request` objects, using the same workflow snapshots seen in `packages/coordination/test/coordination.test.ts`.
4. **Inngest + transport adapters (packages/coordination-inngest)** – ensure `queueCoordinationRunWithInngest` calls the ORPC procedures via `RPCLink` if that becomes the new contract surface. Update `packages/coordination-inngest/test/inngest-adapter.test.ts` to mimic incoming `RPCLink` calls and to assert that Inngest step instrumentation still flows through `queueCoordinationRunWithInngest`. References: `packages/coordination-inngest/src/index.ts`, `apps/server/src/rawr.ts`.
5. **Documentation & research artifacts** – note the dependencies in `docs/projects/agent-coordination-canvas-v1/ORPC_REPO_WIDE_RESEARCH_PLAN.md` and `agent-orpc-network-server-scratch.md` so future lanes know where this harness audit lives. If we create new snapshots or fixtures, mention them in those docs.

## Risks & missing harness capabilities
1. The current server test suite mocks the Inngest client inline (`apps/server/test/rawr.test.ts` lines ~60–90). Once ORPC procedures become the canonical API, we need a small harness to simulate both RPC transport + Inngest event flow to avoid re-implementing that mock in every test.
2. There is no contract drift detector or snapshot today; a stray schema change in `packages/coordination` would only surface when the HTTP tests fail, meaning ORPC consumers (CLI, frontend, Inngest) could diverge silently. We must add a snapshot guard as described above.
3. Test coverage currently leans heavily on HTTP (only `health.test.ts` and `rawr.test.ts` use `app.handle`). Without ORPC-specific handler tests, we’d lose high-level assurances. The migration plan above explicitly adds direct handler fixtures to replace most HTTP coverage.
4. CLI e2e suites (`apps/cli/test/workflow-harden*`) do not assert ORPC behavior at all—they just read CLI JSON. We ought to add one more integration test that invokes the new RPC client (maybe via `apps/cli/src/commands/...`) to prove the CLI still uses the correct contract.

## File pointers
- `apps/server/src/coordination.ts` / `apps/server/src/rawr.ts` – existing route wiring that will need to mount ORPC `RPCHandler`/`OpenAPIHandler`.
- `apps/server/test/health.test.ts` and `apps/server/test/rawr.test.ts` – HTTP-level suites to be replaced with handler-focused equivalents.
- `packages/coordination/test/coordination.test.ts` – baseline for procedure and schema validation.
- `packages/coordination-inngest/test/inngest-adapter.test.ts` – ensures queue + processing logic stays intact.
- `packages/coordination-observability/test/observability.test.ts` – trace/links coverage referenced by server tests.
- `packages/control-plane/test/control-plane.test.ts` – config normalization coverage that may trigger when ORPC adds new config knobs.
- `docs/projects/agent-coordination-canvas-v1/ORPC_REPO_WIDE_RESEARCH_PLAN.md` + `agent-orpc-network-server-scratch.md` – canonical instructions for the oRPC migration scope.

Skills introspected: orpc, architecture, elysia, inngest, bun
